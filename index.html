<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfectoQuiz Master - Organizator v8</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --duo-green: #58cc02; --duo-green-dark: #58a700;
            --duo-red: #ff4b4b; --duo-red-dark: #ea2b2b;
            --duo-blue: #1cb0f6; --duo-blue-dark: #1899d6;
            --duo-gray: #e5e5e5; --text: #4b4b4b;
            --duo-purple: #ce82ff; --duo-purple-dark: #a568cc;
            --duo-yellow: #ffc800; --duo-yellow-dark: #e5b400;
            --bg-board: #e9eaec;
        }
        * { box-sizing: border-box; font-family: 'Nunito', sans-serif; }
        body { background: #f7f7f7; color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* NAV */
        nav { background: white; padding: 15px; display: flex; justify-content: center; gap: 20px; border-bottom: 2px solid var(--duo-gray); flex-shrink: 0; }
        nav button { border: none; background: none; font-weight: 800; color: #afafaf; cursor: pointer; text-transform: uppercase; padding-bottom: 5px; }
        nav button.active { color: var(--duo-blue); border-bottom: 3px solid var(--duo-blue); }

        /* VIEWS */
        .view { display: none; padding: 20px; flex-direction: column; align-items: center; overflow-y: auto; flex: 1; width: 100%; }
        .view.active { display: flex; }

        /* CARDS & CONTAINERS */
        .card { background: white; border: 2px solid var(--duo-gray); border-radius: 16px; padding: 20px; width: 100%; max-width: 600px; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; width: 100%; max-width: 600px; }
        
        /* INPUTS & BUTTONS */
        input, textarea, select { width: 100%; padding: 10px; border: 2px solid var(--duo-gray); border-radius: 10px; margin-bottom: 10px; font-family: inherit; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; margin-top: 10px; transition: 0.1s; text-align: center; display: inline-block; }
        .btn-blue { background: var(--duo-blue); border-bottom: 4px solid var(--duo-blue-dark); }
        .btn-green { background: var(--duo-green); border-bottom: 4px solid var(--duo-green-dark); }
        .btn-red { background: var(--duo-red); border-bottom: 4px solid var(--duo-red-dark); }
        .btn-purple { background: var(--duo-purple); border-bottom: 4px solid var(--duo-purple-dark); }
        .btn-outline { background: white; border: 2px solid var(--duo-gray); border-bottom: 4px solid var(--duo-gray); color: var(--text); }
        .btn:active:not(:disabled) { transform: translateY(4px); border-bottom-width: 0; margin-top: 14px; }
        .btn:disabled { background: #ccc; border-bottom-color: #aaa; cursor: not-allowed; transform: none; }

        /* TOPIC BUTTONS */
        .topic-btn { height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 14px; }
        .topic-count { font-size: 10px; opacity: 0.8; margin-top: 5px; }

        /* QUIZ STYLES */
        .option-btn { width: 100%; padding: 15px; background: white; border: 2px solid var(--duo-gray); border-bottom: 4px solid var(--duo-gray); border-radius: 12px; margin-bottom: 10px; text-align: left; cursor: pointer; font-weight: 700; display: flex; align-items: center; }
        .option-num { width: 25px; height: 25px; border: 2px solid #ddd; border-radius: 6px; display: flex; justify-content: center; align-items: center; margin-right: 10px; color: #999; font-size: 14px; }
        .option-btn.selected { background: #ddf4ff; border-color: var(--duo-blue); color: var(--duo-blue); }
        .option-btn.selected .option-num { border-color: var(--duo-blue); color: var(--duo-blue); }
        .option-btn.correct { background: #d7ffb8; border-color: var(--duo-green); color: var(--duo-green-dark); }
        .option-btn.wrong { background: #ffdfdf; border-color: var(--duo-red); color: var(--duo-red-dark); }

        /* STATS */
        .stat-box { text-align: center; padding: 15px; border-radius: 12px; flex: 1; }
        .stat-num { font-size: 24px; font-weight: 900; display: block; }

        /* KANBAN BOARD STYLES */
        #board-container {
            display: flex;
            overflow-x: auto;
            height: 100%;
            width: 100%;
            padding: 10px;
            gap: 15px;
            align-items: flex-start;
        }
        .column {
            min-width: 300px;
            width: 300px;
            background: #ebecf0;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            flex-shrink: 0;
        }
        .column-header {
            font-weight: 800;
            padding: 10px;
            color: #5e6c84;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .column-header input {
            margin: 0;
            padding: 5px;
            font-size: 16px;
            font-weight: 800;
            background: white;
        }
        .cards-list {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 50px;
            padding: 5px;
        }
        .kanban-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            cursor: grab;
            border-bottom: 2px solid #ddd;
            font-size: 14px;
            transition: transform 0.2s;
        }
        .kanban-card:active { cursor: grabbing; transform: rotate(2deg); }
        .kanban-card:hover { background: #fbfbfb; }
        .drag-over { background: #dcdfe4; border: 2px dashed #999; }
        
        /* LOADING */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--duo-blue); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-log { font-size: 12px; color: #666; margin-top: 10px; padding: 10px; background: #eee; border-radius: 8px; font-family: monospace; display: none; text-align: left; white-space: pre-wrap; }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <h2 style="color: var(--duo-blue); margin: 0;">Trabajando...</h2>
        <p id="loader-text" style="color: #666; max-width: 300px;">Conectando...</p>
    </div>

    <!-- NAVIGATION -->
    <nav>
        <button onclick="setView('home')" id="nav-home" class="active">Estudiar</button>
        <button onclick="setView('organizer')" id="nav-organizer">Organizar</button>
        <button onclick="setView('admin')" id="nav-admin">Editar</button>
        <button onclick="setView('ai')" id="nav-ai">IA M√°gica ‚ú®</button>
    </nav>

    <!-- VIEW: HOME -->
    <div id="view-home" class="view active">
        <div class="card" style="text-align: center;">
            <h2 style="margin-top:0;">¬øQu√© practicamos hoy?</h2>
            <p style="color: #666;">Tienes <strong id="total-q-home">0</strong> preguntas.</p>
            <button onclick="startSession('random')" class="btn btn-blue" style="width: 100%; font-size: 18px; padding: 20px;">üé≤ Practicar Todo</button>
        </div>
        <h3 style="color: #999; margin-bottom: 15px; font-size: 14px;">O ELIGE UN TEMA</h3>
        <div id="topic-grid" class="grid-container"></div>
    </div>

    <!-- VIEW: ORGANIZER (KANBAN) -->
    <div id="view-organizer" class="view" style="padding: 0; align-items: flex-start; background: #2f6dae; overflow-x: auto;">
        <div style="padding: 10px; width: 100%; display: flex; justify-content: space-between; align-items: center; color: white;">
            <span>üí° Arrastra las tarjetas para cambiar el tema. Haz clic en un t√≠tulo para renombrar el tema.</span>
            <button onclick="createNewTopic()" class="btn btn-green" style="width: auto; margin: 0; padding: 8px 15px;">+ Nuevo Tema</button>
        </div>
        <div id="board-container">
            <!-- Columns injected via JS -->
        </div>
    </div>

    <!-- VIEW: QUIZ -->
    <div id="view-quiz" class="view">
        <div style="width: 100%; max-width: 600px; display:flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <button onclick="quitQuiz()" style="font-size:24px; border:none; background:none; cursor:pointer; color:#ccc;">√ó</button>
            <div style="flex-grow:1; height: 16px; background: #e5e5e5; border-radius: 10px; overflow:hidden;">
                <div id="progress" style="width: 0%; height: 100%; background: var(--duo-green); border-radius: 10px; transition: 0.3s;"></div>
            </div>
            <span id="q-counter" style="font-weight: bold; color: #ccc;">0/0</span>
        </div>
        <div class="card">
            <div id="quiz-topic" style="text-align: center; font-size: 12px; font-weight: 800; color: var(--duo-purple); text-transform: uppercase; margin-bottom: 5px; display:none;">TEMA</div>
            <h2 id="quiz-question" style="margin-top:0; text-align: center;">...</h2>
            <div id="quiz-options"></div>
        </div>
        <div id="feedback-area" style="display:none; width: 100%; max-width: 600px; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(0,0,0,0.1);">
            <h2 id="feedback-title" style="margin:0 0 10px 0;"></h2>
            <p id="feedback-text" style="font-size: 16px; line-height: 1.5;"></p>
            <button onclick="nextQuestion()" class="btn" id="continue-btn">CONTINUAR</button>
        </div>
        <button id="check-btn" onclick="checkAnswer()" class="btn btn-green" disabled style="display:none; max-width: 600px;">COMPROBAR</button>
    </div>

    <!-- VIEW: RESULTS -->
    <div id="view-results" class="view">
        <div class="card" style="text-align: center;">
            <h1 style="color: var(--duo-yellow-dark); font-size: 40px; margin: 10px 0;">¬°Lecci√≥n Completa!</h1>
            <div style="display: flex; gap: 10px; margin: 20px 0;">
                <div class="stat-box" style="background: #d7ffb8; color: var(--duo-green-dark);"><span class="stat-num" id="res-correct">0</span> Correctas</div>
                <div class="stat-box" style="background: #ffdfdf; color: var(--duo-red-dark);"><span class="stat-num" id="res-wrong">0</span> Incorrectas</div>
            </div>
            <button id="btn-retry-wrong" onclick="startSession('retry')" class="btn btn-red" style="width: 100%; display: none;">üîÑ Repetir Errores</button>
            <button onclick="setView('home')" class="btn btn-outline" style="width: 100%;">Volver al Inicio</button>
        </div>
    </div>

    <!-- VIEW: ADMIN -->
    <div id="view-admin" class="view">
        <div class="card">
            <h3>üìù Editor Manual</h3>
            <input type="hidden" id="edit-index">
            <label style="font-size:12px;font-weight:800;color:#999;">TEMA</label>
            <input type="text" id="inp-topic" placeholder="Ej: Tuberculosis" style="border-color: var(--duo-purple);">
            <label style="font-size:12px;font-weight:800;color:#999;">PREGUNTA</label>
            <textarea id="inp-question" rows="3" placeholder="Escribe la consigna..."></textarea>
            <div id="options-inputs"></div>
            <label style="font-size:12px;font-weight:800;color:#999;">JUSTIFICACI√ìN</label>
            <textarea id="inp-justification" rows="2" placeholder="Explicaci√≥n..."></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveManual()" class="btn btn-blue" style="flex:1;">Guardar</button>
                <button onclick="clearForm()" class="btn btn-outline" style="flex:1;">Limpiar</button>
            </div>
        </div>
        <div class="card">
            <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display:flex; gap:10px;">
                <button onclick="exportBackup()" class="btn btn-purple" style="font-size:13px; padding:10px; margin:0; width:50%;">üíæ Descargar</button>
                <button onclick="triggerImport()" class="btn btn-purple" style="font-size:13px; padding:10px; margin:0; width:50%;">üìÇ Cargar</button>
                <input type="file" id="import-file" style="display:none" onchange="importBackup(this)" accept=".json">
            </div>
            <div id="questions-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
        <button onclick="resetAllData()" class="btn btn-red" style="max-width: 600px; margin-top:20px;">‚ö†Ô∏è Borrar Todo</button>
    </div>

    <!-- VIEW: IA IMPORT -->
    <div id="view-ai" class="view">
        <div class="card" style="border: 2px solid var(--duo-blue);">
            <h2 style="color: var(--duo-blue); margin-top:0;">ü§ñ Generador IA</h2>
            <label style="font-size:12px;font-weight:800;color:#999;">TU API KEY</label>
            <input type="password" id="api-key" value="" placeholder="Pega tu API Key..." style="background: #f0f8ff;">
            <label style="font-size:12px;font-weight:800;color:#999; margin-top:10px; display:block;">PEGA TUS APUNTES</label>
            <textarea id="ai-prompt" rows="8" placeholder="Texto m√©dico..."></textarea>
            <button id="ai-btn" type="button" class="btn btn-blue">‚ú® PROCESAR TEXTO</button>
            <div id="status-log">Esperando acci√≥n...</div>
            <div id="ai-success-msg" style="display:none; margin-top: 15px; text-align: center;">
                <p style="color: var(--duo-green-dark); font-weight: bold;">¬°√âxito!</p>
                <button onclick="goToAdminWithFilter()" class="btn btn-green">VER PREGUNTAS</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let questions = JSON.parse(localStorage.getItem('infectoDB_v8')) || [];
        
        // Session
        let sessionQuestions = [], sessionWrongQuestions = [], sessionIndex = 0;
        let sessionScore = { correct: 0, wrong: 0 }, selectedOptIndex = null;
        let _tempRetryList = [];
        let tempEmptyColumns = []; // Store names of columns created by user but empty

        if(localStorage.getItem('myGeminiKey')) {
            document.getElementById('api-key').value = localStorage.getItem('myGeminiKey');
        }

        // --- NAV ---
        function setView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + viewId).classList.add('active');
            document.getElementById('view-' + viewId).classList.add('active');
            
            if(viewId === 'home') renderHome();
            if(viewId === 'admin') loadAdminList();
            if(viewId === 'organizer') renderOrganizerBoard();
        }

        // --- ORGANIZER (KANBAN) LOGIC ---
        function renderOrganizerBoard() {
            const board = document.getElementById('board-container');
            board.innerHTML = '';
            
            // 1. Get Topics
            let topics = new Set(questions.map(q => q.tema || "General"));
            tempEmptyColumns.forEach(t => topics.add(t)); // Add manual columns
            
            const sortedTopics = Array.from(topics).sort();

            sortedTopics.forEach(topic => {
                const col = document.createElement('div');
                col.className = 'column';
                col.setAttribute('data-topic', topic);
                
                // Header (Editable)
                const header = document.createElement('div');
                header.className = 'column-header';
                const titleSpan = document.createElement('span');
                titleSpan.innerText = topic;
                titleSpan.onclick = () => enableRename(titleSpan, topic);
                
                const countSpan = document.createElement('span');
                countSpan.style.fontSize = "12px";
                countSpan.style.background = "rgba(0,0,0,0.1)";
                countSpan.style.padding = "2px 6px";
                countSpan.style.borderRadius = "10px";
                
                header.appendChild(titleSpan);
                header.appendChild(countSpan);
                col.appendChild(header);

                // List
                const list = document.createElement('div');
                list.className = 'cards-list';
                
                // Drop Events
                list.ondragover = (e) => {
                    e.preventDefault();
                    list.classList.add('drag-over');
                };
                list.ondragleave = () => list.classList.remove('drag-over');
                list.ondrop = (e) => handleDrop(e, topic, list);

                // Filter Questions
                const qs = questions.filter(q => (q.tema || "General") === topic);
                countSpan.innerText = qs.length;

                qs.forEach((q) => {
                    const card = document.createElement('div');
                    card.className = 'kanban-card';
                    card.draggable = true;
                    card.innerText = q.pregunta;
                    // Store the index of this specific question in the MAIN array
                    const originalIndex = questions.indexOf(q); 
                    card.ondragstart = (e) => {
                        e.dataTransfer.setData("text/plain", originalIndex);
                    };
                    list.appendChild(card);
                });

                col.appendChild(list);
                board.appendChild(col);
            });
        }

        function createNewTopic() {
            const name = prompt("Nombre del nuevo tema:");
            if(name && name.trim() !== "") {
                tempEmptyColumns.push(name.trim());
                renderOrganizerBoard();
            }
        }

        function enableRename(element, oldName) {
            const input = document.createElement('input');
            input.type = "text";
            input.value = oldName;
            input.onblur = () => finalizeRename(oldName, input.value);
            input.onkeydown = (e) => { if(e.key === 'Enter') finalizeRename(oldName, input.value); };
            
            element.replaceWith(input);
            input.focus();
        }

        function finalizeRename(oldName, newName) {
            if(!newName || newName.trim() === "" || newName === oldName) {
                renderOrganizerBoard();
                return;
            }
            // Update all questions
            let changed = false;
            questions.forEach(q => {
                if((q.tema || "General") === oldName) {
                    q.tema = newName.trim();
                    changed = true;
                }
            });
            
            // Update temp columns
            const idx = tempEmptyColumns.indexOf(oldName);
            if(idx > -1) tempEmptyColumns[idx] = newName.trim();

            if(changed || idx > -1) {
                saveToLocal();
                renderOrganizerBoard();
            }
        }

        function handleDrop(e, targetTopic, listEl) {
            e.preventDefault();
            listEl.classList.remove('drag-over');
            const qIndex = e.dataTransfer.getData("text/plain");
            
            if(qIndex !== undefined) {
                const q = questions[parseInt(qIndex)];
                if(q) {
                    q.tema = targetTopic;
                    saveToLocal();
                    renderOrganizerBoard();
                }
            }
        }

        // --- HOME ---
        function renderHome() {
            document.getElementById('total-q-home').innerText = questions.length;
            const grid = document.getElementById('topic-grid');
            grid.innerHTML = '';
            const topics = {};
            questions.forEach(q => {
                const t = q.tema ? q.tema.trim() : "General";
                topics[t] = (topics[t] || 0) + 1;
            });
            Object.keys(topics).forEach(topic => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-purple topic-btn';
                btn.innerHTML = `<strong>${topic}</strong><span class="topic-count">${topics[topic]} preguntas</span>`;
                btn.onclick = () => startSession('topic', topic);
                grid.appendChild(btn);
            });
        }

        // --- SESSION ---
        function startSession(mode, filterValue) {
            sessionQuestions = []; sessionWrongQuestions = []; sessionScore = {correct:0, wrong:0}; sessionIndex = 0;
            if(questions.length === 0) return alert("No hay preguntas.");

            if(mode === 'random') sessionQuestions = [...questions].sort(() => 0.5 - Math.random());
            else if(mode === 'topic') {
                sessionQuestions = questions.filter(q => (q.tema || "General") === filterValue);
                sessionQuestions.sort(() => 0.5 - Math.random());
            } else if(mode === 'retry') {
                sessionQuestions = [..._tempRetryList].sort(() => 0.5 - Math.random());
            }

            if(sessionQuestions.length === 0) return alert("No hay preguntas aqu√≠.");
            setView('quiz');
            loadQuizQuestion();
        }

        function quitQuiz() { if(confirm("¬øSalir?")) setView('home'); }

        function loadQuizQuestion() {
            const container = document.getElementById('quiz-options');
            const qTitle = document.getElementById('quiz-question');
            const qTopic = document.getElementById('quiz-topic');
            const checkBtn = document.getElementById('check-btn');
            
            document.getElementById('feedback-area').style.display = 'none';
            container.innerHTML = '';
            checkBtn.style.display = 'block'; checkBtn.disabled = true;

            if(sessionIndex >= sessionQuestions.length) return finishSession();

            const q = sessionQuestions[sessionIndex];
            qTitle.innerText = q.pregunta;
            qTopic.style.display = 'block'; qTopic.innerText = q.tema || "General";
            document.getElementById('q-counter').innerText = `${sessionIndex + 1}/${sessionQuestions.length}`;
            document.getElementById('progress').style.width = `${((sessionIndex)/sessionQuestions.length)*100}%`;

            q.opciones.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerHTML = `<div class="option-num">${idx+1}</div> <span>${opt.texto}</span>`;
                btn.onclick = () => { if(document.getElementById('feedback-area').style.display === 'block') return; selectOption(idx, btn); };
                container.appendChild(btn);
            });
        }

        function selectOption(idx, btnElement) {
            selectedOptIndex = idx;
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
            document.getElementById('check-btn').disabled = false;
        }

        function checkAnswer() {
            const q = sessionQuestions[sessionIndex];
            const isCorrect = q.opciones[selectedOptIndex].correcta;
            const opts = document.querySelectorAll('.option-btn');
            const fb = document.getElementById('feedback-area');
            const contBtn = document.getElementById('continue-btn');
            
            opts[selectedOptIndex].classList.remove('selected');
            if(isCorrect) {
                opts[selectedOptIndex].classList.add('correct');
                sessionScore.correct++;
                fb.style.background = '#d7ffb8';
                document.getElementById('feedback-title').innerText = "¬°Excelente!";
                contBtn.className = "btn btn-green";
            } else {
                opts[selectedOptIndex].classList.add('wrong');
                sessionScore.wrong++;
                sessionWrongQuestions.push(q);
                const correctIdx = q.opciones.findIndex(o => o.correcta);
                if(correctIdx > -1) opts[correctIdx].classList.add('correct');
                fb.style.background = '#ffdfdf';
                document.getElementById('feedback-title').innerText = "Incorrecto";
                contBtn.className = "btn btn-red";
            }
            document.getElementById('check-btn').style.display = 'none';
            fb.style.display = 'block';
            document.getElementById('feedback-text').innerText = q.justificacion || "";
        }

        function nextQuestion() { sessionIndex++; loadQuizQuestion(); }
        function finishSession() {
            _tempRetryList = [...sessionWrongQuestions];
            document.getElementById('res-correct').innerText = sessionScore.correct;
            document.getElementById('res-wrong').innerText = sessionScore.wrong;
            const btnRetry = document.getElementById('btn-retry-wrong');
            btnRetry.style.display = sessionScore.wrong > 0 ? 'inline-block' : 'none';
            setView('results');
        }

        // --- ADMIN & DATA ---
        const optsContainer = document.getElementById('options-inputs');
        for(let i=0; i<4; i++) {
            optsContainer.innerHTML += `<div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;"><input type="radio" name="correct-radio" id="rad-${i}" ${i===0?'checked':''}><input type="text" id="opt-${i}" placeholder="Opci√≥n ${i+1}" style="margin-bottom:0;"></div>`;
        }

        function loadAdminList() {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            questions.forEach((q, idx) => {
                const item = document.createElement('div');
                item.className = 'q-item';
                item.innerHTML = `<div style="flex:1; padding-right:10px;"><div style="margin-bottom: 2px;"><span class="topic-tag">${q.tema||'General'}</span> <span style="font-weight:800; font-size:12px;">#${idx+1}</span></div><div style="font-size:14px; color:#555;">${q.pregunta.substring(0,60)}...</div></div><div class="q-actions"><button onclick="editQuestion(${idx})">‚úèÔ∏è</button><button onclick="deleteQuestion(${idx})" style="color:red;">üóëÔ∏è</button></div>`;
                list.appendChild(item);
            });
        }

        function saveManual() {
            const idx = document.getElementById('edit-index').value;
            const newOpts = [];
            for(let i=0; i<4; i++) newOpts.push({texto: document.getElementById('opt-'+i).value, correcta: document.getElementById('rad-'+i).checked});
            const newQ = { tema: document.getElementById('inp-topic').value || "General", pregunta: document.getElementById('inp-question').value, opciones: newOpts, justificacion: document.getElementById('inp-justification').value };
            if(!newQ.pregunta) return alert("Falta pregunta");
            if(idx !== "") questions[idx] = newQ; else questions.push(newQ);
            saveToLocal(); clearForm(); loadAdminList(); alert("Guardado");
        }

        function editQuestion(idx) {
            const q = questions[idx];
            document.getElementById('edit-index').value = idx;
            document.getElementById('inp-topic').value = q.tema||"";
            document.getElementById('inp-question').value = q.pregunta;
            document.getElementById('inp-justification').value = q.justificacion;
            q.opciones.forEach((o, i) => { document.getElementById('opt-'+i).value = o.texto; document.getElementById('rad-'+i).checked = o.correcta; });
            document.querySelector('.view.active').scrollTop = 0;
        }
        function deleteQuestion(idx) { if(confirm("¬øBorrar?")) { questions.splice(idx,1); saveToLocal(); loadAdminList(); } }
        function clearForm() { document.getElementById('edit-index').value = ""; document.getElementById('inp-topic').value = ""; document.getElementById('inp-question').value = ""; document.getElementById('inp-justification').value = ""; }
        function resetAllData() { if(confirm("¬øBORRAR TODO?")) { questions=[]; saveToLocal(); loadAdminList(); } }
        function saveToLocal() { localStorage.setItem('infectoDB_v8', JSON.stringify(questions)); }
        
        function exportBackup() {
            const blob = new Blob([JSON.stringify(questions,null,2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function triggerImport() { document.getElementById('import-file').click(); }
        function importBackup(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("¬øReemplazar todo (Aceptar) o Agregar (Cancelar)?")) questions = data; else questions = [...questions, ...data];
                    saveToLocal(); loadAdminList(); alert("Importado");
                } catch(e) { alert("Error archivo"); }
            };
            reader.readAsText(input.files[0]);
        }

        // --- IA ---
        document.getElementById('ai-btn').addEventListener('click', generateWithAI);
        async function fetchAI(url, payload, key) {
            const res = await fetch(url+key, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), referrerPolicy: 'no-referrer' });
            if(!res.ok) throw new Error(res.status);
            return res.json();
        }
        async function generateWithAI() {
            const key = document.getElementById('api-key').value.trim();
            const text = document.getElementById('ai-prompt').value.trim();
            const log = document.getElementById('status-log');
            if(key) localStorage.setItem('myGeminiKey', key);
            
            log.style.display = 'block'; log.innerText = "Conectando...";
            document.getElementById('loader').style.display = 'flex';
            
            const payload = { contents: [{ parts: [{ text: `Act√∫a como profesor de medicina. Analiza el texto y crea un JSON v√°lido con preguntas de opci√≥n m√∫ltiple. Estructura: [{"tema":"...","pregunta":"...","opciones":[{"texto":"...","correcta":true}],"justificacion":"..."}]. Texto: ${text}` }] }] };
            const models = ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-1.0-pro"];
            
            try {
                let data;
                for(let m of models) {
                    try { data = await fetchAI(`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=`, payload, key); break; }
                    catch(e) { log.innerText += `\nFallo ${m}, probando siguiente...`; }
                }
                if(!data) throw new Error("Fallo total");
                
                let raw = data.candidates[0].content.parts[0].text;
                raw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                if(raw.indexOf('[') > 0) raw = raw.substring(raw.indexOf('['));
                if(raw.lastIndexOf(']') < raw.length - 1) raw = raw.substring(0, raw.lastIndexOf(']')+1);

                const newQ = JSON.parse(raw);
                questions = [...questions, ...newQ];
                saveToLocal();
                document.getElementById('loader').style.display = 'none';
                document.getElementById('ai-success-msg').style.display = 'block';
            } catch(e) {
                document.getElementById('loader').style.display = 'none';
                alert("Error: " + e.message);
            }
        }
        
        function goToAdminWithFilter() { setView('admin'); }

        setView('home');
    </script>
</body>
</html>

